.. tags: Tutorials
.. slug: 80-what-a-state-to-get-into
.. title: What a state to get into…
.. date: 27 April 2016 10:57
.. author: Edward Powell


<p><img style="float: left; margin: 6px; display: inline" src="../../../images/old/finitestatemachines-logo.jpg" align="left" height="131" width="205">This
 week we are going to be adding our game state code to the basic (and 
reusable) game loop code from last week. The structure of the code is 
going to be very simple. In the <font face="Courier New"><strong>Update</strong></font> function we are going to choose a particular block of code according to current game state (using the <font size="2" face="Courier New">If…, Elif…, Elif…, Else…</font>
 conditional structure you have encountered previously). Each block of 
code will check input and game data and simply change the current game 
state to a new one if necessary. Essentially all of our game logic will 
be captured in this function – although we will create some other 
‘helper’ functions to complete repetitive tasks without having to copy 
and paste code (if you find yourself doing this, it is a sure sign that 
your code needs a better structure – time to ‘refactor’).</p>  <p>The <font face="Courier New"><strong>Draw</strong></font> code can now be extremely simple. It will just dumbly draw items according to the current game state.</p>  <p><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" alt="image" src="../../../images/old/image_thumb_ce85e2133d615eabdea59a25f3eec26a.png" border="0" height="261" width="580"></p>    <p>The
 diagram above shows a simple design of the 7 new game states we need 
(not including the existing ‘Quit’ state) and the events we will be 
looking for in the Update function to trigger transitions between the 
states. When you design a game you should definitely have something like
 this diagram early on to help you plan your project – pretty much all 
games have some sort of state structure within them.</p>  <p>In our 
simple game, the transition events will either be mouse clicks from the 
player, or internal timers. The timers will determine how long it takes 
for Sam to draw his guns, how quickly he fires and also the duration of 
the animation of firing (essentially how long we remain in the ‘Fire’ 
game state, where we blit the gun flashes, before moving to the ‘Lose’ 
game state, where we don’t).</p>  <h2>Code Snippets</h2>  <p>OK well to be honest that is the hard bit done, the rest is just typing <img class="wlEmoticon wlEmoticon-winkingsmile" style="border-top-style: none; border-left-style: none; border-bottom-style: none; border-right-style: none" alt="Winking smile" src="../../../images/old/wlemoticon-winkingsmile_2_54850c00b06cd9822a681f2c537710d0.png"></p>  <h3></h3>  <h3>Update</h3>  <p>The update function captures the diagram above in code form:</p>  <pre style="font-family: ; color: ; background-color: #ffffff"><span style="color: "><font color="#000080"><strong><font style="font-size: 9pt">def </font></strong></font></span><font style="font-size: 9pt"><font color="#000000">Update():<br>    </font><span style="color: "><font color="#000080"><strong>global </strong></font></span><font color="#000000">current_keys, last_keys, current_mouse, last_mouse, \<br>    gamestate, time_to_draw, time_to_fire, total_time<br><br>    last_keys = current_keys<br>    current_keys = pygame.key.get_pressed()<br><br>    last_mouse = current_mouse<br>    current_mouse = pygame.mouse.get_pressed()<br><br>    elapsed_ms = pygame.time.Clock().tick(</font><span style="color: "><font color="#0000ff">30</font></span><font color="#000000">)<br>    total_time = total_time + elapsed_ms<br><br>    </font><span style="color: "><font color="#000080"><strong>if </strong></font></span><font color="#000000">gamestate == </font><span style="color: "><font color="#008080"><strong>"Start"</strong></font></span><font color="#000000">:<br>        </font><span style="color: "><font color="#000080"><strong>if </strong></font></span><font color="#000000">LeftMouseClicked():<br>            gamestate = </font><strong><font color="#008080"><span style="color: ">"Ready"<br></span><span style="color: ">    </span></font><span style="color: "><font color="#000080">elif </font></span></strong><font color="#000000">gamestate == </font><span style="color: "><font color="#008080"><strong>"Ready"</strong></font></span><font color="#000000">:<br>        </font><span style="color: "><font color="#000080"><strong>if </strong></font></span><font color="#000000">total_time &gt; time_to_draw:<br>            total_time = </font><font color="#0000ff"><span style="color: ">0<br></span><span style="color: ">            </span></font><font color="#000000">gamestate = </font><strong><font color="#008080"><span style="color: ">"Draw"<br></span><span style="color: ">        </span></font><span style="color: "><font color="#000080">elif </font></span></strong><font color="#000000">LeftMouseClicked():<br>            gamestate = </font><strong><font color="#008080"><span style="color: ">"TooEarly"<br></span><span style="color: ">    </span></font><span style="color: "><font color="#000080">elif </font></span></strong><font color="#000000">gamestate == </font><span style="color: "><font color="#008080"><strong>"Draw"</strong></font></span><font color="#000000">:<br>        </font><span style="color: "><font color="#000080"><strong>if </strong></font></span><font color="#000000">total_time &gt; time_to_fire:<br>            total_time = </font><font color="#0000ff"><span style="color: ">0<br></span><span style="color: ">            </span></font><font color="#000000">gamestate = </font><strong><font color="#008080"><span style="color: ">"Fire"<br></span><span style="color: ">        </span></font><span style="color: "><font color="#000080">if </font></span></strong><font color="#000000">LeftMouseClicked():<br>            gamestate = </font><strong><font color="#008080"><span style="color: ">"Win"<br></span><span style="color: ">    </span></font><span style="color: "><font color="#000080">elif </font></span></strong><font color="#000000">gamestate == </font><span style="color: "><font color="#008080"><strong>"Fire"</strong></font></span><font color="#000000">:<br>            gamestate = </font><strong><font color="#008080"><span style="color: ">"Lose"<br></span><span style="color: ">    </span></font><span style="color: "><font color="#000080">elif </font></span></strong><font color="#000000">gamestate == </font><span style="color: "><font color="#008080"><strong>"TooEarly"</strong></font></span><font color="#000000">:<br>        </font><span style="color: "><font color="#000080"><strong>if </strong></font></span><font color="#000000">LeftMouseClicked():<br>            Reset()<br>            gamestate = </font><strong><font color="#008080"><span style="color: ">"Start"<br></span><span style="color: ">    </span></font><span style="color: "><font color="#000080">elif </font></span></strong><font color="#000000">gamestate == </font><span style="color: "><font color="#008080"><strong>"Win"</strong></font></span><font color="#000000">:<br>        </font><span style="color: "><font color="#000080"><strong>if </strong></font></span><font color="#000000">LeftMouseClicked():<br>            Reset()<br>            gamestate = </font><strong><font color="#008080"><span style="color: ">"Start"<br></span><span style="color: ">    </span></font><span style="color: "><font color="#000080">elif </font></span></strong><font color="#000000">gamestate == </font><span style="color: "><font color="#008080"><strong>"Lose"</strong></font></span><font color="#000000">:<br>        </font><span style="color: "><font color="#000080"><strong>if </strong></font></span><font color="#000000">LeftMouseClicked():<br>            Reset()<br>            gamestate = </font><strong><font color="#008080"><span style="color: ">"Start"<br></span><span style="color: ">    </span></font><span style="color: "><font color="#000080">else</font></span></strong><font color="#000000">:<br>        </font><span style="color: "><font color="#000080">print</font></span><font color="#000000">(</font><span style="color: "><font color="#008080"><strong>"Update Error: Unknown gamestate"</strong></font></span><font color="#000000">)</font></font></pre>

<h3>Draw</h3>

<p>The Draw function simply draws the screen according to the current game state:</p>

<pre style="font-family: ; color: ; background-color: #ffffff"><span style="color: "><font color="#000080"><strong><font style="font-size: 9pt">def </font></strong></font></span><font style="font-size: 9pt"><font color="#000000">Draw():<br>    </font><span style="color: "><font color="#000080"><strong>global </strong></font></span><font color="#000000">background_surface, screen, sam_surface_set<br><br>    screen.blit(background_surface, (</font><span style="color: "><font color="#0000ff">0</font></span><font color="#000000">,</font><span style="color: "><font color="#0000ff">0</font></span><font color="#000000">))<br><br>    </font><span style="color: "><font color="#000080"><strong>if </strong></font></span><font color="#000000">gamestate == </font><span style="color: "><font color="#008080"><strong>"Start"</strong></font></span><font color="#000000">:<br>        DrawTitle(</font><span style="color: "><font color="#008080"><strong>"Click to Start"</strong></font></span><font color="#000000">)<br>    </font><span style="color: "><font color="#000080"><strong>elif </strong></font></span><font color="#000000">gamestate == </font><span style="color: "><font color="#008080"><strong>"Ready"</strong></font></span><font color="#000000">:<br>        DrawSam(</font><span style="color: "><font color="#008080"><strong>"Ready"</strong></font></span><font color="#000000">)<br>    </font><span style="color: "><font color="#000080"><strong>elif </strong></font></span><font color="#000000">gamestate == </font><span style="color: "><font color="#008080"><strong>"Draw"</strong></font></span><font color="#000000">:<br>        DrawSam(</font><span style="color: "><font color="#008080"><strong>"Draw"</strong></font></span><font color="#000000">)<br>    </font><span style="color: "><font color="#000080"><strong>elif </strong></font></span><font color="#000000">gamestate == </font><span style="color: "><font color="#008080"><strong>"Fire"</strong></font></span><font color="#000000">:<br>        DrawSam(</font><span style="color: "><font color="#008080"><strong>"Fire"</strong></font></span><font color="#000000">)<br>    </font><span style="color: "><font color="#000080"><strong>elif </strong></font></span><font color="#000000">gamestate == </font><span style="color: "><font color="#008080"><strong>"TooEarly"</strong></font></span><font color="#000000">:<br>        DrawTitle(</font><span style="color: "><font color="#008080"><strong>"You'll hang for this!"</strong></font></span><font color="#000000">)<br>        DrawSam(</font><span style="color: "><font color="#008080"><strong>"Innocent"</strong></font></span><font color="#000000">)<br>    </font><span style="color: "><font color="#000080"><strong>elif </strong></font></span><font color="#000000">gamestate == </font><span style="color: "><font color="#008080"><strong>"Win"</strong></font></span><font color="#000000">:<br>        DrawTitle(</font><span style="color: "><font color="#008080"><strong>"Got me you varmint"</strong></font></span><font color="#000000">)<br>        DrawSam(</font><span style="color: "><font color="#008080"><strong>"Shot"</strong></font></span><font color="#000000">)<br>    </font><span style="color: "><font color="#000080"><strong>elif </strong></font></span><font color="#000000">gamestate == </font><span style="color: "><font color="#008080"><strong>"Lose"</strong></font></span><font color="#000000">:<br>        DrawTitle(</font><span style="color: "><font color="#008080"><strong>"Take that!"</strong></font></span><font color="#000000">)<br>        DrawSam(</font><span style="color: "><font color="#008080"><strong>"Ready"</strong></font></span><font color="#000000">)<br>    </font><span style="color: "><font color="#000080"><strong>else</strong></font></span><font color="#000000">:<br>        </font><span style="color: "><font color="#000080">print</font></span><font color="#000000">(</font><span style="color: "><font color="#008080"><strong>"Draw Error: Unknown gamestate"</strong></font></span><font color="#000000">)<br><br>    pygame.display.flip()<br>    </font></font><span style="color: "><font style="font-size: 9pt" color="#000080"><strong>return</strong></font></span></pre>

<h3>Additional Helper Functions</h3>

<p>To avoid the noob error of cutting and pasting repeated code, and to 
make the code easier to understand and manage, several additional helper
 functions are handy to add. The first checks for a mouse click by 
seeing of the left mouse button is newly pressed – i.e. it is pressed 
this time around the game loop, but not last time – this prevents a 
single mouse click triggering loads of mouse click transitions in one 
go.</p>

<pre style="font-family: ; color: ; background-color: #ffffff"><span style="color: "><font color="#000080"><strong><font style="font-size: 9pt">def </font></strong></font></span><font style="font-size: 9pt"><font color="#000000">LeftMouseClicked():<br>    </font><span style="color: "><font color="#000080"><strong>global </strong></font></span><font color="#000000">current_mouse, last_mouse<br>    </font><span style="color: "><font color="#000080"><strong>return </strong></font></span><font color="#000000">current_mouse[</font><span style="color: "><font color="#0000ff">0</font></span><font color="#000000">] </font><span style="color: "><font color="#000080"><strong>and not </strong></font></span><font color="#000000">last_mouse[</font><span style="color: "><font color="#0000ff">0</font></span><font color="#000000">]</font></font></pre>

<p>Note that this function returns the boolean True or False so you can 
use it anywhere that python needs a boolean. This is an example of a 
function with a return type and they are very handy things!</p>

<p>We also can draw a nice centred bit of large text using the DrawTitle function:</p>

<pre style="font-family: ; color: ; background-color: #ffffff"><span style="color: "><font color="#000080"><strong><font style="font-size: 9pt">def </font></strong></font></span><font style="font-size: 9pt"><font color="#000000">DrawTitle(string):<br>    </font><span style="color: "><font color="#000080"><strong>global </strong></font></span><font color="#000000">big_font, screen<br>    text = big_font.render(string, </font><span style="color: "><font color="#0000ff">1</font></span><font color="#000000">, (</font><span style="color: "><font color="#0000ff">255</font></span><font color="#000000">, </font><span style="color: "><font color="#0000ff">128</font></span><font color="#000000">, </font><span style="color: "><font color="#0000ff">128</font></span><font color="#000000">))<br>    shadow = big_font.render(string, </font><span style="color: "><font color="#0000ff">1</font></span><font color="#000000">, (</font><span style="color: "><font color="#0000ff">0</font></span><font color="#000000">, </font><span style="color: "><font color="#0000ff">0</font></span><font color="#000000">, </font><span style="color: "><font color="#0000ff">0</font></span><font color="#000000">))<br>    textpos = text.get_rect()<br>    textpos.centerx = screen.get_rect().centerx<br>    shadowpos = shadow.get_rect()<br>    shadowpos.center = (textpos.centerx + </font><span style="color: "><font color="#0000ff">2</font></span><font color="#000000">, textpos.centery + </font><span style="color: "><font color="#0000ff">2</font></span><font color="#000000">)<br>    screen.blit(shadow, shadowpos)<br>    screen.blit(text, textpos)</font></font></pre>

<p>Finally, Sam himself is represented by a set of surfaces – different 
ones for the game states. To store these I use a dictionary structure to
 allow us to get the surface we are after using a nice, friendly, string
 name. I create this dictionary just once inside the Init function, 
along with the global fonts used above:</p>

<pre style="font-family: ; color: ; background-color: #ffffff"><span style="color: "><font color="#808080"><em><font style="font-size: 9pt"># Load the other sprite images</font></em></font><font style="font-size: 9pt"><br></font></span><font style="font-size: 9pt"><font color="#000000">sam_surface_set = { \<br>    </font><span style="color: "><font color="#008080"><strong>"Ready" </strong></font></span><font color="#000000">:  pygame.image.load(</font><span style="color: "><font color="#008080"><strong>"images/YosemiteSamReady.png"</strong></font></span><font color="#000000">).convert_alpha(), \<br>    </font><span style="color: "><font color="#008080"><strong>"Draw" </strong></font></span><font color="#000000">:  pygame.image.load(</font><span style="color: "><font color="#008080"><strong>"images/YosemiteSamAim.png"</strong></font></span><font color="#000000">).convert_alpha(), \<br>    </font><span style="color: "><font color="#008080"><strong>"Fire" </strong></font></span><font color="#000000">:  pygame.image.load(</font><span style="color: "><font color="#008080"><strong>"images/YosemiteSamFire.png"</strong></font></span><font color="#000000">).convert_alpha(), \<br>    </font><span style="color: "><font color="#008080"><strong>"Innocent" </strong></font></span><font color="#000000">:  pygame.image.load(</font><span style="color: "><font color="#008080"><strong>"images/YosemiteSamInnocent.png"</strong></font></span><font color="#000000">).convert_alpha(), \<br>    </font><span style="color: "><font color="#008080"><strong>"Shot" </strong></font></span><font color="#000000">:  pygame.image.load(</font><span style="color: "><font color="#008080"><strong>"images/YosemiteSamShot.png"</strong></font></span><font color="#000000">).convert_alpha() \<br>}</font><br><br><span style="color: "><font color="#808080"><em># Create some reusable fonts</em></font><br></span><font color="#000000">big_font = pygame.font.Font(</font><span style="color: "><font color="#000080"><strong>None</strong></font></span><font color="#000000">, </font><span style="color: "><font color="#0000ff">72</font></span><font color="#000000">)<br>little_font = pygame.font.Font(</font><span style="color: "><font color="#000080"><strong>None</strong></font></span><font color="#000000">, </font><span style="color: "><font color="#0000ff">36</font></span><font color="#000000">)</font></font></pre>

<p>then I use it inside a handy DrawSam function that will draw the correct Sam according to the name that you pass in:</p>

<pre style="font-family: ; color: ; background-color: #ffffff"><span style="color: "><font color="#000080"><strong><font style="font-size: 9pt">def </font></strong></font></span><font style="font-size: 9pt"><font color="#000000">DrawSam(state_string):<br>    </font><span style="color: "><font color="#000080"><strong>global </strong></font></span><font color="#000000">screen<br>    sam_surface = <span><font style="background-color: #e4e4ff">sam_surface_set</font></span>[state_string]<br>    target = sam_surface.get_rect()<br>    target.center = screen.get_rect().center<br>    screen.blit(sam_surface, target)</font></font></pre>

<p>That’s it! In your version of the game try adding some new game 
states or swap out the images for a different theme of game. Perhaps a 
high score screen showing the fastest reaction time achieved in this 
session of the game?</p>



